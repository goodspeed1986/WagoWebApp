<!DOCTYPE>
<html>

<head>
    <title>Single Page Web Application for Wago Controllers</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <script type="text/javascript" src="smoothie.js"></script>
    
    <script>
    window.onload = function() {
        var sdbUrl = '../../plc/download.sdb'; // PLC 750-880
        var webvisuUrl = '../../plc/webvisu.htm'; // PLC 750-880
        getPlcVars(sdbUrl, function (err, varsJson) { 
                if (!err) {
                    startPoll(varsJson, webvisuUrl);
                } else
                {
                    alert (err)
                    setTimeout(function() {getPlcVars(sdbUrl)}, 10000);
                }
            })

	    createTimeline();
    }    

    setInterval(function() {
        line1.append(new Date().getTime(), document.getElementById("var2").innerHTML);
    }, 1000);

    var line1 = new TimeSeries();      
    function createTimeline() {
        var smoothie = new SmoothieChart({millisPerPixel:60,maxValueScale:1.17,grid:{fillStyle:'rgba(0,0,0,0.74)',strokeStyle:'rgba(119,119,119,0.41)',sharpLines:true},labels:{fontSize:12,precision:4},maxValue:100,minValue:0,timestampFormatter:SmoothieChart.timeFormatter});
        smoothie.addTimeSeries(line1, {lineWidth:2,strokeStyle:'#00ff00'});
        smoothie.streamTo(document.getElementById("trend"), 1000);
    }
    </script>
</head>

<body>
    <h1>Variables from Codesys</h1>
    <h2>BOOL</h2>
    <button onmouseup="WriteValue(4,146,0,1,1)">On</button>
    <button onmouseup="WriteValue(4,146,0,1,0)">Off</button>
    <div id='var1'></div>
    <h2>REAL</h2>
    <div id='var2'></div>
    <h2>STRING</h2>
    <div id='var3'></div>
    <p>Real Time Trend</p>
    <canvas id="trend" width="500" height="200"></canvas>

<script>



function WriteValue(RefId,Offset,Type,Size,Value){
	 var req = null;
    if (window.XMLHttpRequest) {
        try {
            req = new XMLHttpRequest();
        } catch (e){}
    } else if (window.ActiveXObject) {
        try {
            req = new ActiveXObject('Msxml2.XMLHTTP');
        } catch (e){
            try {
                req = new ActiveXObject('Microsoft.XMLHTTP');
            } catch (e){}
        }
    }

    if (req) {       
        req.open("POST", '/webvisu/webvisu.htm', true);
	    req.send('|1|1|0|'+RefId+'|'+Offset+'|'+Size+'|'+Type+'|'+Value+'|');
    }
}
 
function bin2String(array) {
   return String.fromCharCode.apply(String, array);
}

function sdb2Json(buf) {
   let sdb = {};
   var dv = new DataView(buf);
   let typesCnt = dv.getUint32(36, true);
   let aTypes = [];
   let aVars = [];
   let offset = 40;
   let ix = 0;
   while (ix <= typesCnt - 1) {
      offset += 8;
      aTypes[ix] = {};
      //Тип переменной
      aTypes[ix].Type = dv.getUint32(offset, true);
      offset += 4;
      //Размер типа
      aTypes[ix].Size = dv.getUint32(offset, true);
      offset += 4;
      let nameLen = dv.getUint16(offset, true);
      offset += 2;
      //Имя Типа
      let aName = [];
      for (let i = 0; i < nameLen; i++) {
         if (dv.getUint8(offset) !== 0) {
            aName[i] = dv.getUint8(offset);
         }
         offset++;
      }
      let sName = bin2String(aName);
      aTypes[ix].Name = sName;
      if (aTypes[ix].Type == 9) {
         offset += 16
      }
      if (aTypes[ix].Name === 'DATA') {
         let typesCntData = dv.getUint32(offset, true);
         offset += 4;
         let jx = 0;
         while (jx <= typesCntData - 1) {
            offset += 24;
            let nameLenData = dv.getUint16(offset, true);
            offset += 2;
            for (let i = 0; i < nameLenData; i++) {
               offset++;
            }
            jx++;
         }
      }
      ix++;
   }
   offset += 12;
   let varsCnt = dv.getUint32(offset, true);
   offset += 4;
   ix = 0
   // let jx = 1;
   while (ix <= varsCnt - 1) {
      offset += 8;
      aVars[ix] = {};
      let desc = dv.getUint32(offset, true);
      aVars[ix].Type = aTypes[desc].Type;
      aVars[ix].Size = aTypes[desc].Size;
      offset += 8;
      aVars[ix].Access = dv.getUint16(offset, true);
      offset += 2;
      aVars[ix].RefId = dv.getUint16(offset, true);
      offset += 2;
      aVars[ix].Offset = dv.getUint32(offset, true);
      offset += 4;
      let nameLen = dv.getUint16(offset, true);
      offset += 2;
      let aName = [];
      for (let i = 0; i < nameLen; i++) {
         if (dv.getUint8(offset) !== 0) {
            aName[i] = dv.getUint8(offset);
         }
         offset++;
      }
      let sName = bin2String(aName);
      aVars[ix].Name = sName;
      ix++;
   }
   sdb.types = aTypes;
   sdb.vars = aVars;
   return sdb
}

function getPlcValues(plcVars, webvisuUrl, cb) {
   var cnt = plcVars.length;
   var postData = '|0|' + cnt;
   var ix = 0;

   plcVars.forEach(function (item) {
      var out = '|' + ix + '|' + item.RefId + '|' + item.Offset + '|' + item.Size + '|' + item.Type;
      ix++;
      postData += out;
   }, this);
   postData += '|';

   var req = null;
    if (window.XMLHttpRequest) {
        try {
            req = new XMLHttpRequest();
        } catch (e){}
    } else if (window.ActiveXObject) {
        try {
            req = new ActiveXObject('Msxml2.XMLHTTP');
        } catch (e){
            try {
                req = new ActiveXObject('Microsoft.XMLHTTP');
            } catch (e){}
        }
    }

   var arr = [];
   req.open("post", webvisuUrl, true);
   req.overrideMimeType("text/html; charset=windows-1251");
   req.setRequestHeader("Content-type", "text/html; charset=windows-1251");
   req.timeout = 3000;
   req.send(postData);

   req.onreadystatechange = function () {
      if (req.readyState == 4) {
         if (req.status == 200) {
            arr = req.responseText.split('|');
            arr.splice(0, 1)
            return cb(null, arr)
         }
         else {
            return cb('PLC_NOT_RESPONSE_VALUES');
         }
      }
   }
}

function getPlcVars(sdbUrl, cb) {

	var req = null;
    if (window.XMLHttpRequest) {
        try {
            req = new XMLHttpRequest();
        } catch (e){}
    } else if (window.ActiveXObject) {
        try {
            req = new ActiveXObject('Msxml2.XMLHTTP');
        } catch (e){
            try {
                req = new ActiveXObject('Microsoft.XMLHTTP');
            } catch (e){}
        }
    }

   req.open("get", sdbUrl, true);
   req.timeout = 3000;
   req.responseType = "arraybuffer";
   try {
      req.send(null);
   }
   catch (e) {
      req.abort();
   }
   req.onreadystatechange = function () {
      if (req.readyState == 4) {
         if (req.status == 200) {
            let buf = req.response;
            if (buf) {
               let varsJson = sdb2Json(buf).vars;
               return cb(null, varsJson);
            }
         }
         else {
            return cb('PLC_NOT_RESPONSE_VARS');
         }
      }
   }
}

function startPoll(plcVars, webvisuUrl) {
    getPlcValues(plcVars, webvisuUrl, function (err, arr){
        if (!err) {
            // for (var i=0;i<plcVars.length; i++) {
            //     plcVars[i].Value=arr[i];
            // }
            document.getElementById('var1').innerHTML=arr[1];
            document.getElementById('var2').innerHTML=arr[2];
            document.getElementById('var3').innerHTML=arr[3];
            setTimeout(function() {startPoll(plcVars,webvisuUrl)}, 200);
        } else
        {
            alert (err);
            setTimeout(function() {startPoll(plcVars,webvisuUrl)}, 10000);
        }
    }
)}

</script>

</body>

</html>